<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="ilisten"><title>Spring Boot Profile解析 · Someone's blog</title><meta name="description" content="作者 | 二师兄
来源 | 程序新视界
在实践的过程中我们经常会遇到不同的环境需要不同配置文件的情况，如果每换一个环境重新修改配置文件或重新打包一次会比较麻烦，Spring Boot 为此提供了 Profile 配置来解决此问题。
Profile 的作用Profile 对应中文并没有合适的翻译，它的"><meta name="keywords" content="Java,Web"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">Someone's blog</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">记录</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">Home</a></li><li><a href="/archives">Archive</a></li><li><a href="/tags">Tags</a></li><li class="soc"><a href="https://ilisten.github.io/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://ilisten.github.io" rel="noopener noreferrer">ilisten</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>Spring Boot Profile解析</a></p><p class="post-meta"><span class="date meta-item">Posted at&nbsp;2020-06-03</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/Java/" title="Java" class="a-tag">Java</a><span>&nbsp;</span><a href="/tags/Spring-Boot/" title="Spring-Boot" class="a-tag">Spring-Boot</a><span>&nbsp;</span></span></p><p class="post-abstract"><p><img src="https://mmbiz.qpic.cn/mmbiz_jpg/CmnN7FKTMS4PvB3R7FG3Kjr4v8icpl4odSibxFtd40MJiaBEch9hibrGPBcXPYz3pt8SDC8lZMhgZep7S3ocAv8WbQ/640?wx_fmt=jpeg" alt=""></p>
<p>作者 | 二师兄</p>
<p>来源 | 程序新视界</p>
<p>在实践的过程中我们经常会遇到不同的环境需要不同配置文件的情况，如果每换一个环境重新修改配置文件或重新打包一次会比较麻烦，Spring Boot 为此提供了 Profile 配置来解决此问题。</p>
<h2 id="Profile-的作用"><a href="#Profile-的作用" class="headerlink" title="Profile 的作用"></a>Profile 的作用</h2><p>Profile 对应中文并没有合适的翻译，它的主要作用就是让 Spring Boot 可以根据不同环境提供不同的配置功能支持。</p>
<p>我们经常遇到这样的场景：有开发、测试、生产等环境，不同的环境又有不同的配置。如果每个环境在部署时都需要修改配置文件将会非常麻烦，而通过 Profile 则可以轻松解决改问题。</p>
<h2 id="Profile-的基本使用"><a href="#Profile-的基本使用" class="headerlink" title="Profile 的基本使用"></a>Profile 的基本使用</h2><p>比如上述环境，我们可以在 Spring Boot 中创建 4 个文件：</p>
<ul>
<li><p>applcation.properties：公共配置</p>
</li>
<li><p>application-dev.properties：开发环境配置</p>
</li>
<li><p>application-test.properties：测试环境配置</p>
</li>
<li><p>application-prod.properties：生产环境配置</p>
</li>
</ul>
<p>在 <code>applcation.properties</code> 中配置公共配置，然后通过如下配置激活指定环境的配置：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.profiles.active </span>= <span class="string">prod</span></span><br></pre></td></tr></table></figure>

<p>其中 “prod” 对照文件名中 <code>application-prod.properties</code>。Spring Boot 在处理时会获取配置文件 <code>applcation.properties</code>，然后通过指定的 profile 的值 “prod” 进行拼接，获得 <code>application-prod.properties</code> 文件的名称和路径。</p>
<p>举例说明，比如在开发环境使用服务的端口为 8080，而在生产环境中需要使用 18080 端口。那么，在 <code>application-prod.properties</code> 中配置如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">8080</span></span><br></pre></td></tr></table></figure>

<p>而在 <code>application-prod.properties</code> 中配置为：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">server.port</span>=<span class="string">18080</span></span><br></pre></td></tr></table></figure>

<p>在使用不同环境时，可以通过在 <code>applcation.properties</code> 中配置 <code>spring.profiles.active</code> 属性值来进行指定（如上面示例），也可以通过启动命令参数进行指定：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -jar springboot.jar --spring.profiles.active=prod</span><br></pre></td></tr></table></figure>

<p>这样打包后的程序只需通过命令行参数就可以使用不同环境的配置文件。</p>
<h2 id="基于-yml-文件类型"><a href="#基于-yml-文件类型" class="headerlink" title="基于 yml 文件类型"></a>基于 yml 文件类型</h2><p>如果配置文件是基于 yml 文件类型，还可以将所有的配置放在同一个配置文件中：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="string">active:</span> <span class="string">prod</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="string">port:</span> <span class="number">18080</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="string">profiles:</span> <span class="string">dev</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="string">port:</span> <span class="number">8080</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="string">profiles:</span> <span class="string">test</span></span><br><span class="line"></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="string">port:</span> <span class="number">8081</span></span><br></pre></td></tr></table></figure>

<p>上述配置以 <code>---</code> 进行分割，其中第一个位置的为默认的 <code>profile</code>，比如上述配置启动时，默认使用 <code>18080</code> 端口。如果想使用指定的端口同样可以采用上述命令启动时指定。</p>
<h2 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h2><p>下面带大家简单看一下在 Spring Boot 中针对 Profile 的基本处理流程（不会过度细化具体操作）。在 Spring Boot 启动的过程中执行其 <code>run</code> 方法时，会执行如下一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ConfigurableApplicationContext <span class="title">run</span><span class="params">(String... args)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ApplicationArguments applicationArguments = <span class="keyword">new</span>  DefaultApplicationArguments(args);</span><br><span class="line">    ConfigurableEnvironment environment = prepareEnvironment(listeners, applicationArguments);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>prepareEnvironment</code> 方法的相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ConfigurableEnvironment <span class="title">prepareEnvironment</span><span class="params">(SpringApplicationRunListeners listeners,</span></span></span><br><span class="line"><span class="function"><span class="params">  ApplicationArguments applicationArguments)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  listeners.environmentPrepared(environment);</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>prepareEnvironment</code> 方法处理业务的过程中会调用 <code>SpringApplicationRunListeners</code> 的 <code>environmentPrepared</code> 方法发布事件。该方法会遍历注册在 <code>spring.factories</code> 中 <code>SpringApplicationRunListener</code> 实现类，然后调用其 <code>environmentPrepared</code> 方法。</p>
<p>其中 <code>spring.factories</code> 中 <code>SpringApplicationRunListener</code> 实现类注册为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># Run Listeners</span><br><span class="line">org.springframework.boot.SpringApplicationRunListener =</span><br><span class="line">org.springframework.boot.context.event.EventPublishingRunListener</span><br></pre></td></tr></table></figure>

<p><code>SpringApplicationRunListeners</code> 方法中的调用代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (SpringApplicationRunListener listener : <span class="keyword">this</span>.listeners) &#123;</span><br><span class="line">    listener.environmentPrepared(environment);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>listeners</code> 便是注册的类的集合，这里默认只有 <code>EventPublishingRunListener</code>。它的 <code>environmentPrepared</code> 方法实现为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">environmentPrepared</span><span class="params">(ConfigurableEnvironment environment)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.initialMulticaster</span><br><span class="line">    .multicastEvent(<span class="keyword">new</span> ApplicationEnvironmentPreparedEvent(<span class="keyword">this</span>.application, <span class="keyword">this</span>.args, environment));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其实就是发布了一个监听事件。该事件会被同样注册在 <code>spring.factories</code> 中的 <code>ConfigFileApplicationListener</code> 监听到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Application Listeners</span><br><span class="line">org.springframework.context.ApplicationListener=\</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">org.springframework.boot.context.config.ConfigFileApplicationListener</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>关于配置文件的核心处理便在 <code>ConfigFileApplicationListener</code> 中完成。在该类中我们可以看到很多熟悉的常量：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigFileApplicationListener</span> <span class="keyword">implements</span> <span class="title">EnvironmentPostProcessor</span>, <span class="title">SmartApplicationListener</span>, <span class="title">Ordered</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_PROPERTIES = <span class="string">"defaultProperties"</span>;</span><br><span class="line">  <span class="comment">// Note the order is from least to most specific (last one wins)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_SEARCH_LOCATIONS = <span class="string">"classpath:/,classpath:/config/,file:./,file:./config/"</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_NAMES = <span class="string">"application"</span>;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如 Spring Boot 默认寻找的配置文件的名称、默认扫描的类路径等。</p>
<p>不仅如此，该类还实现了监听器 <code>SmartApplicationListener</code> 接口和 <code>EnvironmentPostProcessor</code> 接口也就是拥有了监听器和环境处理的功能。</p>
<p>其 <code>onApplicationEvent</code> 方法对接收到事件进行判断，如果是 <code>ApplicationEnvironmentPreparedEvent</code> 事件则调用 <code>onApplicationEnvironmentPreparedEvent</code> 方法进行处理，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onApplicationEvent</span><span class="params">(ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationEnvironmentPreparedEvent) &#123;</span><br><span class="line">    onApplicationEnvironmentPreparedEvent((ApplicationEnvironmentPreparedEvent) event);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (event <span class="keyword">instanceof</span> ApplicationPreparedEvent) &#123;</span><br><span class="line">    onApplicationPreparedEvent(event);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>onApplicationEnvironmentPreparedEvent</code> 会获取到对应的 <code>EnvironmentPostProcessor</code> 并调用其 <code>postProcessEnvironment</code> 方法进行处理。而 <code>loadPostProcessors</code> 方法获取的 <code>EnvironmentPostProcessor</code> 正是在 <code>spring.factories</code> 中配置的当前类。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">onApplicationEnvironmentPreparedEvent</span><span class="params">(ApplicationEnvironmentPreparedEvent event)</span> </span>&#123;</span><br><span class="line">  List&lt;EnvironmentPostProcessor&gt; postProcessors = loadPostProcessors();</span><br><span class="line">  postProcessors.add(<span class="keyword">this</span>);</span><br><span class="line">  AnnotationAwareOrderComparator.sort(postProcessors);</span><br><span class="line">  <span class="keyword">for</span> (EnvironmentPostProcessor postProcessor : postProcessors) &#123;</span><br><span class="line">    postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>经过一系列的调用，最终调用到该类的如下方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addPropertySources</span><span class="params">(ConfigurableEnvironment environment, ResourceLoader resourceLoader)</span> </span>&#123;</span><br><span class="line">  RandomValuePropertySource.addToEnvironment(environment);</span><br><span class="line">  <span class="keyword">new</span> Loader(environment, resourceLoader).load();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中 <code>Loader</code> 类为 <code>ConfigFileApplicationListener</code> 内部类，提供了具体处理配置文件优先级、profile、加载解析等功能。</p>
<p>比如，在 Loader 类的 load 方法中便有如下一段代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (PropertySourceLoader loader : <span class="keyword">this</span>.propertySourceLoaders) &#123;</span><br><span class="line">  <span class="keyword">if</span> (canLoadFileExtension(loader, location)) &#123;</span><br><span class="line">    load(loader, location, profile, filterFactory.getDocumentFilter(profile), consumer);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该代码遍历 <code>PropertySourceLoader</code> 列表，并进行对应配置文件的解析，而这里的列表中的 <code>PropertySourceLoader</code> 同样配置在 <code>spring.factories</code> 中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># PropertySource Loaders</span><br><span class="line">org.springframework.boot.env.PropertySourceLoader=\</span><br><span class="line">org.springframework.boot.env.PropertiesPropertySourceLoader,\</span><br><span class="line">org.springframework.boot.env.YamlPropertySourceLoader</span><br></pre></td></tr></table></figure>

<p>查看这两 <code>PropertySourceLoader</code> 的源代码，会发现 Spring Boot 默认支持的配置文件格式及解析方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PropertiesPropertySourceLoader</span> <span class="keyword">implements</span> <span class="title">PropertySourceLoader</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String XML_FILE_EXTENSION = <span class="string">".xml"</span>;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String[] getFileExtensions() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123; <span class="string">"properties"</span>, <span class="string">"xml"</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;PropertySource&lt;?&gt;&gt; load(String name, Resource resource) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    Map&lt;String, ?&gt; properties = loadProperties(resource);</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@SuppressWarnings</span>(&#123; <span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span> &#125;)</span><br><span class="line">  <span class="keyword">private</span> Map&lt;String, ?&gt; loadProperties(Resource resource) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    String filename = resource.getFilename();</span><br><span class="line">    <span class="keyword">if</span> (filename != <span class="keyword">null</span> &amp;&amp; filename.endsWith(XML_FILE_EXTENSION)) &#123;</span><br><span class="line">      <span class="keyword">return</span> (Map) PropertiesLoaderUtils.loadProperties(resource);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OriginTrackedPropertiesLoader(resource).load();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>比如 <code>PropertiesPropertySourceLoader</code> 中支持了 xml 和 properties 两种格式的配置文件，并分别提供了 <code>PropertiesLoaderUtils</code> 和 <code>OriginTrackedPropertiesLoader</code> 两个类进行相应的处理。</p>
<p>同样的 <code>YamlPropertySourceLoader</code> 支持 yml 和 yaml 格式的配置文件，并且采用 <code>OriginTrackedYamlLoader</code> 类进行解析。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YamlPropertySourceLoader</span> <span class="keyword">implements</span> <span class="title">PropertySourceLoader</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String[] getFileExtensions() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> String[] &#123; <span class="string">"yml"</span>, <span class="string">"yaml"</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> List&lt;PropertySource&lt;?&gt;&gt; load(String name, Resource resource) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    List&lt;Map&lt;String, Object&gt;&gt; loaded = <span class="keyword">new</span> OriginTrackedYamlLoader(resource).load();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当然，在 <code>ConfigFileApplicationListener</code> 类中还实现了上面提到的如何拼接默认配置文件和 profile 的实现，相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadForFileExtension</span><span class="params">(PropertySourceLoader loader, String prefix, String fileExtension,</span></span></span><br><span class="line"><span class="function"><span class="params">  Profile profile, DocumentFilterFactory filterFactory, DocumentConsumer consumer)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (profile != <span class="keyword">null</span>) &#123;</span><br><span class="line">    String profileSpecificFile = prefix + <span class="string">"-"</span> + profile + fileExtension;</span><br><span class="line">    load(loader, profileSpecificFile, profile, defaultFilter, consumer);</span><br><span class="line">    load(loader, profileSpecificFile, profile, profileFilter, consumer);</span><br><span class="line">    <span class="comment">// Try profile specific sections in files we've already processed</span></span><br><span class="line">    <span class="keyword">for</span> (Profile processedProfile : <span class="keyword">this</span>.processedProfiles) &#123;</span><br><span class="line">      <span class="keyword">if</span> (processedProfile != <span class="keyword">null</span>) &#123;</span><br><span class="line">        String previouslyLoaded = prefix + <span class="string">"-"</span> + processedProfile + fileExtension;</span><br><span class="line">        load(loader, previouslyLoaded, profile, profileFilter, consumer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ConfigFileApplicationListener</code> 类中还实现了其他更多的功能，大家感兴趣的话可以 debug 进行阅读。</p>
<p><img src="https://mmbiz.qpic.cn/mmbiz_png/j0ROiac4adEsDO74OB9XY6RFiaAy5MicfmBicB6lz3wf0cpX9fyMc6z5kaEjx5DrgBFdibB9t4EXnmuEHKJzHUhghJg/640?wx_fmt=png" alt=""></p>
</p></div><div class="share"><span>Share</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=https://ilisten.github.io/2020/06/03/Spring-Boot-Profile解析/%20Someone' target="_blank" rel="noopener"s blog%20Spring Boot Profile解析" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2020/06/03/hello-world/" title="Hello World">Next post: Hello World&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://ilisten.github.io" rel="noopener noreferrer">ilisten</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>