<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="ilisten"><title>从零认识 fastDFS · Someone's blog</title><meta name="description" content="从零认识 fastDFS1. 简单介绍1.1 简介fastDFS 是一个开源的高性能分布式文件系统（DFS）它的主要功能包括：

文件存储
文件同步
文件访问
高容量和负载平衡

主要解决了海量数据存储问题，特别适合以中小文件（建议范围：4KB &amp;lt; file_size &amp;lt;500MB）为载"><meta name="keywords" content="Java,Web"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/bootstrap.min.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="stylesheet" href="/css/style.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"><meta name="generator" content="Hexo 4.2.1"><link rel="stylesheet" href="/css/prism.css" type="text/css">
<link rel="stylesheet" href="/css/prism-line-numbers.css" type="text/css"></head><body><div id="stage" class="container"><div class="row"><div id="side-bar" class="col-sm-3 col-xs-12 side-container invisible"><div class="vertical-text site-title"><h3 tabindex="-1" class="site-title-small"><a href="/" class="a-title">Someone's blog</a></h3><h1 tabindex="-1" class="site-title-large"><a href="/" class="a-title">记录</a></h1><!--h6(onclick="triggerSiteNav()") Trigger--></div><br class="visible-lg visible-md visible-sm"><div id="site-nav" class="site-title-links"><ul><li><a href="/">首页</a></li><li><a href="/archives">归档</a></li><li><a href="/tags">标签</a></li><li class="soc"><a href="https://github.com/ilisten" target="_blank" rel="noopener noreferrer"><i class="fa fa-github">&nbsp;</i></a><a href="https://ilisten.github.io/atom.xml" target="_blank" rel="noopener noreferrer"><i class="fa fa-rss">&nbsp;</i></a></li></ul><div class="visible-lg visible-md visible-sm site-nav-footer"><br class="site-nav-footer-br"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://ilisten.github.io" rel="noopener noreferrer">ilisten</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div><div id="main-container" class="col-sm-9 col-xs-12 main-container invisible"><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post-container"><p class="post-title"><a>从零认识 fastDFS</a></p><p class="post-meta"><span class="date meta-item">发布于&nbsp;2020-06-04</span><span class="meta-item"><i class="fa fa-tag"></i><span>&nbsp;</span><a href="/tags/架构/" title="架构" class="a-tag">架构</a><span>&nbsp;</span><a href="/tags/图床/" title="图床" class="a-tag">图床</a><span>&nbsp;</span><a href="/tags/分布式/" title="分布式" class="a-tag">分布式</a><span>&nbsp;</span><a href="/tags/文件系统/" title="文件系统" class="a-tag">文件系统</a><span>&nbsp;</span></span></p><p class="post-abstract"><h1 id="从零认识-fastDFS"><a href="#从零认识-fastDFS" class="headerlink" title="从零认识 fastDFS"></a>从零认识 fastDFS</h1><h2 id="1-简单介绍"><a href="#1-简单介绍" class="headerlink" title="1. 简单介绍"></a>1. 简单介绍</h2><h3 id="1-1-简介"><a href="#1-1-简介" class="headerlink" title="1.1 简介"></a>1.1 简介</h3><p>fastDFS 是一个开源的高性能分布式文件系统（DFS）<br>它的主要功能包括：</p>
<ul>
<li>文件存储</li>
<li>文件同步</li>
<li>文件访问</li>
<li>高容量和负载平衡</li>
</ul>
<p>主要解决了海量数据存储问题，特别适合以中小文件（建议范围：4KB &lt; file_size &lt;500MB）为载体的在线服务</p>
<h3 id="1-2-优缺点"><a href="#1-2-优缺点" class="headerlink" title="1.2 优缺点"></a>1.2 优缺点</h3><p>FastDFS具有以下优点：</p>
<ul>
<li><p>结构简单，元数据节点压力低</p>
</li>
<li><p>扩容简单，扩容后文件自动同步，无需重新平衡</p>
</li>
<li><p>高性能，文件处理速度快，适合海量小文件存储</p>
</li>
<li><p>支持小文件合并</p>
</li>
</ul>
<p>缺点在于：</p>
<ul>
<li><p>不能自定义文件key，自己定义会降低灵活性</p>
</li>
<li><p>数据恢复效率低：磁盘镜像分布，修复速度取决于磁盘写入速度</p>
</li>
<li><p>大文件冲击问题：大文件没有分片，导致大文件的读写都由单块硬盘承担，对磁盘的冲击很大，由于我们主要以小文件为主，所以影响较小</p>
</li>
<li><p>缺乏自动化故障恢复机制、运维机制和在线配置能力</p>
</li>
<li><p>源 <em>Storage</em> 写一份即返回成功，源 <em>Storage</em> 出现故障，就可能导致数据丢失，建立监控告警机制，对 <em>Storage</em> 进行检测，实现出现故障时及时通知处理</p>
</li>
<li><p>缺乏必要的安全访问控制机制以及文件数据保护措施，通过文件服务网关可以自己实现访问控制与数据保护</p>
</li>
</ul>
<h2 id="2-运行机制"><a href="#2-运行机制" class="headerlink" title="2. 运行机制"></a>2. 运行机制</h2><h3 id="2-1-角色"><a href="#2-1-角色" class="headerlink" title="2.1 角色"></a>2.1 角色</h3><p>FastDFS 系统有三个角色</p>
<ul>
<li><p><strong>跟踪服务器(Tracker Server)</strong></p>
<p>  主要做调度工作，起到均衡的作用。负责管理所有的 <em>Storage Server</em> 和 <em>Group*，每个 *Storage Server</em> 在启动后会连接 Tracker，告知自己所属 <em>Group</em> 等信息，并保持周期性心跳</p>
<p>  集群中多个 <em>Tracker Server</em> 是对等的，没有主从之分</p>
</li>
<li><p><strong>存储服务器(Storage Server)</strong></p>
<p>  主要提供容量和备份服务。以 <em>Group</em> 为单位，每个 <em>Group</em> 内可以有多台 <em>Storage Server*，同一个 *Group</em> 内的多台 <em>Storage Server</em> 是对等的，数据互为备份；会定期地向 <em>Tracker Server</em> 发送自己的存储信息</p>
</li>
<li><p><strong>客户端(Client)</strong></p>
<p>  上传下载数据的服务器，也就是我们自己的项目所部署在的服务器</p>
</li>
</ul>
<p><img src="./images/fastdfs-outline.png" alt="图片"></p>
<h3 id="2-2-存储策略"><a href="#2-2-存储策略" class="headerlink" title="2.2 存储策略"></a>2.2 存储策略</h3><p>为了支持大容量，存储节点（服务器）采用了分卷（或分组）的组织方式。存储系统由一个或多个卷组成，卷与卷之间的文件是相互独立的，所有卷的文件容量累加就是整个存储系统中的文件容量。一个卷可以由一台或多台存储服务器组成，一个卷下的存储服务器中的文件都是相同的，卷中的多台存储服务器起到了冗余备份和负载均衡的作用</p>
<p>在卷中增加服务器时，同步已有的文件由系统自动完成，同步完成后，系统自动将新增服务器切换到线上提供服务。当存储空间不足或即将耗尽时，可以动态添加卷。只需要增加一台或多台服务器，并将它们配置为一个新的卷，这样就扩大了存储系统的容量</p>
<p><img src="./images/fastdfs-save.jpg" alt="简单扩展"></p>
<p><em>Client</em> 与 <em>Storage Server</em> 的通信，都需要先与 <em>Tracker Server</em> 进行交互。</p>
<p><em>Tracker Server</em> 就像是一个目录索引</p>
<h3 id="2-3-上传"><a href="#2-3-上传" class="headerlink" title="2.3 上传"></a>2.3 上传</h3><blockquote>
<p>当 <em>Tracker Server Cluster</em> 中的 <em>Tracker Server</em> 不止一个时，各个 <em>Tracker Server</em> 之间的关系是对等的，所以客户端上传时可以选择任意一个 <em>Tracker Server</em></p>
</blockquote>
<p>上传的流程</p>
<ol>
<li><p><em>Client</em> 向 <em>Tracker Server</em> 请求上传</p>
</li>
<li><p><em>Tracker Server</em> 为该文件分配一个可以存储文件的 <em>Group</em> 和 <em>Group</em> 中的某一个 <em>Storage Server</em></p>
</li>
<li><p><em>Client</em> 向 <em>Storage Server</em> 发送写文件请求</p>
</li>
<li><p><em>Storage Server</em> 将会</p>
<ul>
<li>为文件分配一个数据存储目录</li>
<li>为文件分配一个fileid</li>
<li>根据以上的信息生成文件名存储文件</li>
</ul>
</li>
<li><p><em>Client</em> 接收到如下信息（包含了文件名）</p>
<p> <img src="./images/fastdfs-filename.png" alt="示例"></p>
</li>
</ol>
<p><img src="./images/fastdfs-upload.png" alt="流程图"></p>
<h3 id="2-4-下载"><a href="#2-4-下载" class="headerlink" title="2.4 下载"></a>2.4 下载</h3><p>下载的流程</p>
<ol>
<li><p><em>Client</em> 向 <em>Tracker Server</em> 请求下载（带上 <strong>文件名</strong>）</p>
</li>
<li><p><em>Tracker Server</em> 将会</p>
<ul>
<li>解析 <strong>文件名</strong>，得到 <em>Group</em>、大小、创建时间等信息</li>
<li>为该请求分配一个 <em>Storage Server</em></li>
</ul>
</li>
<li><p><em>Client</em> 向 <em>Storage Server</em> 发送读文件请求</p>
</li>
<li><p><em>Storage Server</em> 查找文件并返回</p>
</li>
</ol>
<p><img src="./images/fastdfs-download.png" alt="流程图"></p>
<h3 id="2-5-同步"><a href="#2-5-同步" class="headerlink" title="2.5 同步"></a>2.5 同步</h3><p>写文件时：</p>
<ul>
<li>客户端将文件写至 <em>Group*内一个 *Storage Server</em> 即认为写文件成功</li>
<li><em>Storage Server</em> 写完文件后，会由后台线程将文件同步至同一 <em>Group*内其他的 *Storage Server</em></li>
</ul>
<p>写文件后：</p>
<ul>
<li><p>同时会写一份 <code>binlog</code>。</p>
<blockquote>
<figure class="highlight plain"><figcaption><span>里不包含文件数据，只包含文件名等元信息，这份 ```binlog``` 用于后台同步</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">*Storage Server* 会记录向 *Group* 内其他 *Storage Server* 同步的进度，以便重启后能接上次的进度继续同步</span><br><span class="line"></span><br><span class="line">进度以 **时间戳** 的方式进行记录，所以最好能保证集群内所有server的时钟保持同步。</span><br><span class="line"></span><br><span class="line">*Storage Server* 的同步进度会作为元数据的一部分汇报到 *Tracker Server* 上，*Tracker Server* 在选择读 *Storage Server* 的时候会以同步进度作为参考</span><br><span class="line"></span><br><span class="line">## 3. 服务架构方案</span><br><span class="line"></span><br><span class="line">| 公司&#x2F;组织 | 链接 |</span><br><span class="line">| :---- | :---- |</span><br><span class="line">| 中通 | &lt;https:&#x2F;&#x2F;www.secrss.com&#x2F;articles&#x2F;8139&gt; |</span><br><span class="line">| 七牛 | &lt;https:&#x2F;&#x2F;blog.qiniu.com&#x2F;archives&#x2F;198&gt; |</span><br><span class="line"></span><br><span class="line">### 3.1 集群部署示例</span><br><span class="line"></span><br><span class="line">&lt;https:&#x2F;&#x2F;t.hao0.me&#x2F;storage&#x2F;2016&#x2F;05&#x2F;10&#x2F;fastdfs-practice.html&gt;</span><br><span class="line"></span><br><span class="line">摘录如下：</span><br><span class="line"></span><br><span class="line">- 环境介绍</span><br><span class="line"></span><br><span class="line">   |||</span><br><span class="line">   | :--- | :--- |</span><br><span class="line">   | 操作系统 | Centos6.7 Final |</span><br><span class="line">   | FastDFS版本 | fastdfs-5.05.tar.gz |</span><br><span class="line">   | libfastcommon | &lt;https:&#x2F;&#x2F;github.com&#x2F;happyfish100&#x2F;libfastcommon&gt; |</span><br><span class="line">   | nginx | nginx-1.9.9.tar.gz |</span><br><span class="line">   | fastdfs-nginx-module | fastdfs-nginx-module_1.16 |</span><br><span class="line"></span><br><span class="line">   demo 开发环境</span><br><span class="line"></span><br><span class="line"> ![开发环境](.&#x2F;images&#x2F;fastdfs-demo-jiagou.png)</span><br><span class="line"></span><br><span class="line">- 公共库 libfastcommon 安装</span><br><span class="line"></span><br><span class="line">需要注意fastdfs和fastcommon的安装目录，后面安装fastdfs-nginx-module时需要配置</span><br><span class="line"></span><br><span class="line">   &#96;&#96;&#96;bash</span><br><span class="line">   git clone git@github.com:happyfish100&#x2F;libfastcommon.git</span><br><span class="line">   cd libfastcommon</span><br><span class="line">   .&#x2F;make.sh</span><br><span class="line">   .&#x2F;make.sh install </span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>fastdfs 安装</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tar -zxf fastdfs-5.05.tar.gz</span><br><span class="line"><span class="built_in">cd</span> fastdfs-5.05</span><br><span class="line">./make.sh</span><br><span class="line">./make.sh install</span><br></pre></td></tr></table></figure>
</li>
<li><p>Tracker 安装</p>
<ol>
<li><p>配置Tracker(vim /etc/fdfs/tracker.conf)：</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 是否禁用该配置文件</span></span><br><span class="line"><span class="comment"># false：开启</span></span><br><span class="line"><span class="comment"># true：禁用</span></span><br><span class="line"><span class="attr">disabled</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 绑定地址</span></span><br><span class="line"><span class="comment"># 空字符表示绑定所有地址</span></span><br><span class="line"><span class="attr">bind_addr</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 端口设置</span></span><br><span class="line"><span class="attr">port</span>=<span class="string">22122</span></span><br><span class="line"><span class="comment"># 连接超时设置</span></span><br><span class="line"><span class="attr">connect_timeout</span>=<span class="string">30</span></span><br><span class="line"><span class="comment"># 网络超时设置</span></span><br><span class="line"><span class="attr">network_timeout</span>=<span class="string">30</span></span><br><span class="line"><span class="comment"># 存储数据和日志的目录</span></span><br><span class="line"><span class="attr">base_path</span>=<span class="string">/mnt/fastdfs</span></span><br><span class="line"><span class="comment"># 最大并发连接数</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="string">256</span></span><br><span class="line"><span class="comment"># 接受请求的线程数</span></span><br><span class="line"><span class="attr">accept_threads</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 执行请求的线程数 &lt;= max_connections</span></span><br><span class="line"><span class="attr">work_threads</span>=<span class="string">4</span></span><br><span class="line"><span class="comment"># 如何选择上传文件的存储group</span></span><br><span class="line"><span class="comment"># 0: 轮询</span></span><br><span class="line"><span class="comment"># 1: 制定group名称</span></span><br><span class="line"><span class="comment"># 2: 负载均衡, 选择空闲空间最大的存储group</span></span><br><span class="line"><span class="attr">store_lookup</span>=<span class="string">2</span></span><br><span class="line"><span class="comment"># 选择哪一个存储group，当store_lookup=1时，须指定存储group的名称</span></span><br><span class="line"><span class="attr">store_group</span>=<span class="string">group2</span></span><br><span class="line"><span class="comment"># 如何选择上传文件的存储server</span></span><br><span class="line"><span class="comment"># 0: 轮询</span></span><br><span class="line"><span class="comment"># 1: 以ip地址排序的第一个地址</span></span><br><span class="line"><span class="comment"># 2: 以优先级排序</span></span><br><span class="line"><span class="attr">store_server</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 选择存储server的哪一个路径(磁盘或挂载点)上传文件</span></span><br><span class="line"><span class="comment"># 0: 轮询</span></span><br><span class="line"><span class="comment"># 2: 负载均衡, 选择空闲空间最大的路径来存储文件</span></span><br><span class="line"><span class="attr">store_path</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 选择哪一个存储server下载文件</span></span><br><span class="line"><span class="comment"># 0: 轮询</span></span><br><span class="line"><span class="comment"># 1: 选择该文件上传时的那个存储server</span></span><br><span class="line"><span class="attr">download_server</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 预留的存储空间 G(GB) M(MB) K(KB) 默认byte(B)，% 表示比例，如下，预留的存储空间为10%，即只占用90%</span></span><br><span class="line"><span class="attr">reserved_storage_space</span> = <span class="string">10%</span></span><br><span class="line"><span class="comment"># log级别：alert error notice info debug</span></span><br><span class="line"><span class="attr">log_level</span>=<span class="string">info</span></span><br><span class="line"><span class="comment"># 运行用户组，默认当前用户组</span></span><br><span class="line"><span class="attr">run_by_group</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 运行用户，默认当前用户</span></span><br><span class="line"><span class="attr">run_by_user</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 允许的host，例子如下</span></span><br><span class="line"><span class="comment"># "*" 表示所有</span></span><br><span class="line"><span class="comment"># 10.0.1.[1-15,20]</span></span><br><span class="line"><span class="comment"># host[01-08,20-25].domain.com:</span></span><br><span class="line"><span class="comment"># allow_hosts=10.0.1.[1-15,20]</span></span><br><span class="line"><span class="comment"># allow_hosts=host[01-08,20-25].domain.com</span></span><br><span class="line"><span class="attr">allow_hosts</span>=<span class="string">*</span></span><br><span class="line"><span class="comment"># 同步内存日志到磁盘的间隔时间，默认10s</span></span><br><span class="line"><span class="attr">sync_log_buff_interval</span> = <span class="string">10</span></span><br><span class="line"><span class="comment"># 检查存储server存活的间隔时间，默认120s</span></span><br><span class="line"><span class="attr">check_active_interval</span> = <span class="string">120</span></span><br><span class="line"><span class="comment"># 线程栈大小 &gt;= 64KB</span></span><br><span class="line"><span class="attr">thread_stack_size</span> = <span class="string">64KB</span></span><br><span class="line"><span class="comment"># 当存储server变化时，是否自动调整存储server的ip</span></span><br><span class="line"><span class="attr">storage_ip_changed_auto_adjust</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"># 存储server同步文件的最大延时，默认86400s(1天)</span></span><br><span class="line"><span class="attr">storage_sync_file_max_delay</span> = <span class="string">86400</span></span><br><span class="line"><span class="comment"># 存储server同步一个文件的最大时间</span></span><br><span class="line"><span class="attr">storage_sync_file_max_time</span> = <span class="string">300</span></span><br><span class="line"><span class="comment"># 是否用一个主文件存储多个小文件</span></span><br><span class="line"><span class="attr">use_trunk_file</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 最小的slot大小(多个小文件之间的空隙大小)，小于4k</span></span><br><span class="line"><span class="attr">slot_min_size</span> = <span class="string">256</span></span><br><span class="line"><span class="comment"># 最大的slot大小(多个小文件之间的空隙大小) &gt; slot_min_size</span></span><br><span class="line"><span class="comment"># 当上传的文件大小 &lt; slot_max_size时，那么该文件将合并到一个主文件</span></span><br><span class="line"><span class="attr">slot_max_size</span> = <span class="string">16MB</span></span><br><span class="line"><span class="comment"># 主文件大小 &gt;= 4MB</span></span><br><span class="line"><span class="attr">trunk_file_size</span> = <span class="string">64MB</span></span><br><span class="line"><span class="comment"># 是否提前创建trunk文件</span></span><br><span class="line"><span class="attr">trunk_create_file_advance</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 创建trunk文件的基准时间</span></span><br><span class="line"><span class="attr">trunk_create_file_time_base</span> = <span class="string">02:00</span></span><br><span class="line"><span class="comment"># 创建trunk文件的间隔时间，默认86400s(1天)</span></span><br><span class="line"><span class="attr">trunk_create_file_interval</span> = <span class="string">86400</span></span><br><span class="line"><span class="comment"># 创建trunk文件的阈值空间</span></span><br><span class="line"><span class="attr">trunk_create_file_space_threshold</span> = <span class="string">20G</span></span><br><span class="line"><span class="comment"># 当加载trunk空间空间时，是否检查trunk空间占用情况，设置为true，启动会变慢</span></span><br><span class="line"><span class="attr">trunk_init_check_occupying</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 是否忽略storage_trunk.dat</span></span><br><span class="line"><span class="attr">trunk_init_reload_from_binlog</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 压缩trunk binlog文件的间隔时间</span></span><br><span class="line"><span class="comment"># 0表示不压缩</span></span><br><span class="line"><span class="attr">trunk_compress_binlog_min_interval</span> = <span class="string">0</span></span><br><span class="line"><span class="comment"># 是否使用storage ID，而不是ip地址</span></span><br><span class="line"><span class="attr">use_storage_id</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 定义storage ids文件，相对或绝对路径</span></span><br><span class="line"><span class="attr">storage_ids_filename</span> = <span class="string">storage_ids.conf</span></span><br><span class="line"><span class="comment"># 存储id类型，当use_storage_id=true时有效</span></span><br><span class="line"><span class="comment">## ip: 存储server的IP</span></span><br><span class="line"><span class="comment">## id: 存储server的ID</span></span><br><span class="line"><span class="attr">id_type_in_filename</span> = <span class="string">ip</span></span><br><span class="line"><span class="comment"># 是否使用链接文件存储slave文件</span></span><br><span class="line"><span class="attr">store_slave_file_use_link</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 是否滚动错误日志文件</span></span><br><span class="line"><span class="attr">rotate_error_log</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 滚动错误日志文件的时间点</span></span><br><span class="line"><span class="attr">error_log_rotate_time</span>=<span class="string">00:00</span></span><br><span class="line"><span class="comment"># 当错误日志文件超出该值时，滚动错误日志文件</span></span><br><span class="line"><span class="attr">rotate_error_log_size</span> = <span class="string">0</span></span><br><span class="line"><span class="comment"># 保存日志文件的天数</span></span><br><span class="line"><span class="comment"># 0表示不删除日志文件</span></span><br><span class="line"><span class="attr">log_file_keep_days</span> = <span class="string">0</span></span><br><span class="line"><span class="comment"># 是否使用连接池</span></span><br><span class="line"><span class="attr">use_connection_pool</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 连接最大空闲时间</span></span><br><span class="line"><span class="attr">connection_pool_max_idle_time</span> = <span class="string">3600</span></span><br><span class="line"><span class="comment"># tracker的http端口</span></span><br><span class="line"><span class="meta">http.server_port</span>=<span class="string">8080</span></span><br><span class="line"><span class="comment"># 检查http server存活的时间间隔</span></span><br><span class="line"><span class="meta">http.check_alive_interval</span>=<span class="string">30</span></span><br><span class="line"><span class="comment"># 检查http sever存活的类型</span></span><br><span class="line"><span class="comment">#   tcp : 仅连接http端口，不发请求</span></span><br><span class="line"><span class="comment">#   http: 发http请求，并需返回200</span></span><br><span class="line"><span class="comment"># default value is tcp</span></span><br><span class="line"><span class="meta">http.check_alive_type</span>=<span class="string">tcp</span></span><br><span class="line"><span class="comment"># 检查http server的uri</span></span><br><span class="line"><span class="meta">http.check_alive_uri</span>=<span class="string">/status.html</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Tracker：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>自启动Tracker：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'/usr/bin/fdfs_trackerd /etc/fdfs/tracker.conf restart'</span> &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
</li>
<li><p>依法部署另一个 Tracker</p>
</li>
</ol>
</li>
<li><p>Storage 安装</p>
<ol>
<li><p>配置Storage(vim /etc/fdfs/storage.conf)：</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 是否禁用该配置文件# false：开启</span></span><br><span class="line"><span class="comment"># true：禁用</span></span><br><span class="line"><span class="attr">disabled</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 组名称</span></span><br><span class="line"><span class="attr">group_name</span>=<span class="string">group1</span></span><br><span class="line"><span class="comment"># 绑定地址</span></span><br><span class="line"><span class="comment"># 空字符表示绑定所有地址</span></span><br><span class="line"><span class="attr">bind_addr</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 当连接其他存储server时，是否绑定地址</span></span><br><span class="line"><span class="attr">client_bind</span>=<span class="string">true</span></span><br><span class="line"><span class="comment"># 存储server端口</span></span><br><span class="line"><span class="attr">port</span>=<span class="string">23000</span></span><br><span class="line"><span class="comment"># 连接超时</span></span><br><span class="line"><span class="attr">connect_timeout</span>=<span class="string">30</span></span><br><span class="line"><span class="comment"># 网络超时</span></span><br><span class="line"><span class="attr">network_timeout</span>=<span class="string">60</span></span><br><span class="line"><span class="comment"># 心跳</span></span><br><span class="line"><span class="attr">heart_beat_interval</span>=<span class="string">30</span></span><br><span class="line"><span class="comment"># 磁盘使用报道的时间间隔</span></span><br><span class="line"><span class="attr">stat_report_interval</span>=<span class="string">60</span></span><br><span class="line"><span class="comment"># 数据和日志目录</span></span><br><span class="line"><span class="attr">base_path</span>=<span class="string">/mnt/fastdfs</span></span><br><span class="line"><span class="comment"># 最大并发连接数</span></span><br><span class="line"><span class="attr">max_connections</span>=<span class="string">256</span></span><br><span class="line"><span class="comment"># 接收和发送数据的缓冲区大小</span></span><br><span class="line"><span class="attr">buff_size</span> = <span class="string">256KB</span></span><br><span class="line"><span class="comment"># 接受请求的线程数</span></span><br><span class="line"><span class="attr">accept_threads</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 执行请求的线程数</span></span><br><span class="line"><span class="attr">work_threads</span>=<span class="string">4</span></span><br><span class="line"><span class="comment"># 磁盘读写是否分开</span></span><br><span class="line"><span class="attr">disk_rw_separated</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"># 每个存储基路径的读线程数</span></span><br><span class="line"><span class="attr">disk_reader_threads</span> = <span class="string">1</span></span><br><span class="line"><span class="comment"># 每个存储基路径的写线程数</span></span><br><span class="line"><span class="attr">disk_writer_threads</span> = <span class="string">1</span></span><br><span class="line"><span class="comment"># 当没有进行同步时, 多少毫秒后读取binlog</span></span><br><span class="line"><span class="attr">sync_wait_msec</span>=<span class="string">50</span></span><br><span class="line"><span class="comment"># 当同步完一个文件后, 暂停多少毫秒</span></span><br><span class="line"><span class="comment"># 0 表示不调用usleep</span></span><br><span class="line"><span class="attr">sync_interval</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 每天存储同步的开始时间</span></span><br><span class="line"><span class="attr">sync_start_time</span>=<span class="string">00:00</span></span><br><span class="line"><span class="comment"># 每天存储同步的结束时间</span></span><br><span class="line"><span class="attr">sync_end_time</span>=<span class="string">23:59</span></span><br><span class="line"><span class="comment"># 同步多少个文件后，写入mark文件</span></span><br><span class="line"><span class="attr">write_mark_file_freq</span>=<span class="string">500</span></span><br><span class="line"><span class="comment"># 路径(磁盘或挂载点)数</span></span><br><span class="line"><span class="attr">store_path_count</span>=<span class="string">1</span></span><br><span class="line"><span class="comment"># 存储路径</span></span><br><span class="line"><span class="attr">store_path0</span>=<span class="string">/mnt/fastdfs</span></span><br><span class="line"><span class="comment"># 子目录数</span></span><br><span class="line"><span class="attr">subdir_count_per_path</span>=<span class="string">256</span></span><br><span class="line"><span class="comment"># tracker地址，可以配置多个tracker_server</span></span><br><span class="line"><span class="attr">tracker_server</span>=<span class="string">10.112.88.105:22122</span></span><br><span class="line"><span class="comment"># tracker_server=10.112.88.104:22122</span></span><br><span class="line"><span class="comment"># 日志级别：alert error notice info debug</span></span><br><span class="line"><span class="attr">log_level</span>=<span class="string">debug</span></span><br><span class="line"><span class="comment"># 运行进程的用户组，默认当前用户组</span></span><br><span class="line"><span class="attr">run_by_group</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 运行进程的用户，默认当前用户</span></span><br><span class="line"><span class="attr">run_by_user</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 允许的host，例子如下# "*" 表示所有</span></span><br><span class="line"><span class="comment"># 10.0.1.[1-15,20]</span></span><br><span class="line"><span class="comment"># host[01-08,20-25].domain.com:</span></span><br><span class="line"><span class="comment"># allow_hosts=10.0.1.[1-15,20]</span></span><br><span class="line"><span class="comment"># allow_hosts=host[01-08,20-25].domain.com</span></span><br><span class="line"><span class="attr">allow_hosts</span>=<span class="string">*</span></span><br><span class="line"><span class="comment"># 文件分布模式</span></span><br><span class="line"><span class="comment"># 0: 轮询</span></span><br><span class="line"><span class="comment"># 1: 随机</span></span><br><span class="line"><span class="attr">file_distribute_path_mode</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 写多少个文件后，轮到下一个路径</span></span><br><span class="line"><span class="attr">file_distribute_rotate_count</span>=<span class="string">100</span></span><br><span class="line"><span class="comment"># 当写入多大文件时，调用fsync</span></span><br><span class="line"><span class="comment"># 0: 不调用</span></span><br><span class="line"><span class="comment"># other: 文件大小(byte)</span></span><br><span class="line"><span class="attr">fsync_after_written_bytes</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 同步内存日志到磁盘的间隔时间，默认10s</span></span><br><span class="line"><span class="attr">sync_log_buff_interval</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># 同步binlog到磁盘的间隔时间，默认10s</span></span><br><span class="line"><span class="attr">sync_binlog_buff_interval</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># 同步存储状态信息到磁盘的间隔时间，默认300s</span></span><br><span class="line"><span class="attr">sync_stat_file_interval</span>=<span class="string">300</span></span><br><span class="line"><span class="comment"># 线程栈大小 &gt;= 512KB</span></span><br><span class="line"><span class="attr">thread_stack_size</span>=<span class="string">512KB</span></span><br><span class="line"><span class="comment"># 上传文件的优先级，tracker中使用</span></span><br><span class="line"><span class="attr">upload_priority</span>=<span class="string">10</span></span><br><span class="line"><span class="comment"># the NIC alias prefix, such as eth in Linux, you can see it by ifconfig -a</span></span><br><span class="line"><span class="comment"># multi aliases split by comma. empty value means auto set by OS type</span></span><br><span class="line"><span class="comment"># default values is empty</span></span><br><span class="line"><span class="attr">if_alias_prefix</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># 是否检查文件重复</span></span><br><span class="line"><span class="attr">check_file_duplicate</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># 文件签名方法</span></span><br><span class="line"><span class="comment">## hash: hash</span></span><br><span class="line"><span class="comment">## md5: MD5</span></span><br><span class="line"><span class="attr">file_signature_method</span>=<span class="string">hash</span></span><br><span class="line"><span class="comment"># 存储文件索引的命名空间，check_file_duplicate=true时</span></span><br><span class="line"><span class="attr">key_namespace</span>=<span class="string">FastDFS</span></span><br><span class="line"><span class="comment"># 设置与FastDHT保持长连接的数目，0表示使用短连接</span></span><br><span class="line"><span class="attr">keep_alive</span>=<span class="string">0</span></span><br><span class="line"><span class="comment"># FastDHT server列表，需要安装FastDHT</span></span><br><span class="line"><span class="comment">##include /home/yuqing/fastdht/conf/fdht_servers.conf</span></span><br><span class="line"><span class="comment"># 是否记录访问日志</span></span><br><span class="line"><span class="attr">use_access_log</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"># 是否每天滚动访问日志文件</span></span><br><span class="line"><span class="attr">rotate_access_log</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"># 访问日志滚动时间点</span></span><br><span class="line"><span class="attr">access_log_rotate_time</span>=<span class="string">00:00</span></span><br><span class="line"><span class="comment"># 是否每天滚动错误日志文件</span></span><br><span class="line"><span class="attr">rotate_error_log</span> = <span class="string">true</span></span><br><span class="line"><span class="comment"># 错误日志滚动时间点</span></span><br><span class="line"><span class="attr">error_log_rotate_time</span>=<span class="string">00:00</span></span><br><span class="line"><span class="comment"># 访问日志滚动大小</span></span><br><span class="line"><span class="attr">rotate_access_log_size</span> = <span class="string">0</span></span><br><span class="line"><span class="comment"># 错误日志滚动大小</span></span><br><span class="line"><span class="attr">rotate_error_log_size</span> = <span class="string">0</span></span><br><span class="line"><span class="comment"># 日志保留天数</span></span><br><span class="line"><span class="attr">log_file_keep_days</span> = <span class="string">7</span></span><br><span class="line"><span class="comment"># 同步文件时是否跳过无效的文件</span></span><br><span class="line"><span class="attr">file_sync_skip_invalid_record</span>=<span class="string">false</span></span><br><span class="line"><span class="comment"># 是否使用连接池</span></span><br><span class="line"><span class="attr">use_connection_pool</span> = <span class="string">false</span></span><br><span class="line"><span class="comment"># 连接最大空间时间</span></span><br><span class="line"><span class="attr">connection_pool_max_idle_time</span> = <span class="string">3600</span></span><br><span class="line"><span class="comment"># 域名</span></span><br><span class="line"><span class="meta">http.domain_name</span>=<span class="string"></span></span><br><span class="line"><span class="comment"># http端口</span></span><br><span class="line"><span class="meta">http.server_port</span>=<span class="string">8888</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>启动Storage：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart</span><br></pre></td></tr></table></figure>
</li>
<li><p>自启动Storage：</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'/usr/bin/fdfs_storaged /etc/fdfs/storage.conf restart'</span> &gt;&gt; /etc/rc.d/rc.local</span><br></pre></td></tr></table></figure>
</li>
</ol>
</li>
<li><p>Nginx 安装</p>
<blockquote>
<p>通常，对于图片和文件的访问，是不太可能走TCP，而是通过简单的HTTP访问，这时需要通过一些Web服务器(如nginx，apache)来代理</p>
</blockquote>
<p>  fastdfs也有了nginx的支持，下面则将通过安装nginx来完成文件访问，之前的开发环境将变为：</p>
<p>  <img src="./images/fastdfs-demo-jiagou-nginx.png" alt="nginx"></p>
<p>  整合步骤</p>
<ol>
<li><p>在Storage上配置fastdfs-nginx-module所需的配置文件</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置fastdfs-nginx-module所需的配置文件mod_fastdfs.conf，http.conf，mime.types</span></span><br><span class="line"><span class="comment"># vim /etc/fdfs/mod_fastdfs.conf</span></span><br><span class="line"><span class="attr">connect_timeout</span>=<span class="string">5</span></span><br><span class="line"><span class="attr">network_timeout</span>=<span class="string">30</span></span><br><span class="line"><span class="attr">base_path</span>=<span class="string">/mnt/fastdfs/logs</span></span><br><span class="line"><span class="attr">load_fdfs_parameters_from_tracker</span>=<span class="string">true</span></span><br><span class="line"><span class="attr">storage_sync_file_max_delay</span> = <span class="string">86400</span></span><br><span class="line"><span class="attr">use_storage_id</span> = <span class="string">false</span></span><br><span class="line"><span class="attr">storage_ids_filename</span> = <span class="string">storage_ids.conf</span></span><br><span class="line"><span class="attr">tracker_server</span>=<span class="string">10.112.88.105:22122</span></span><br><span class="line"><span class="attr">storage_server_port</span>=<span class="string">23000</span></span><br><span class="line"><span class="attr">group_name</span>=<span class="string">group1 			# 与该Storage的配置一致</span></span><br><span class="line"><span class="attr">url_have_group_name</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">store_path_count</span>=<span class="string">1 			# 与该Storage的配置一致</span></span><br><span class="line"><span class="attr">store_path0</span>=<span class="string">/mnt/fastdfs 	# 与该Storage的配置一致</span></span><br><span class="line"><span class="attr">log_level</span>=<span class="string">debug</span></span><br><span class="line"><span class="attr">log_filename</span>=<span class="string">/usr/local/nginx/logs/mod_fastdfs.log</span></span><br><span class="line"><span class="attr">response_mode</span>=<span class="string">proxy</span></span><br><span class="line"><span class="attr">if_alias_prefix</span>=<span class="string"></span></span><br><span class="line"><span class="comment">#include http.conf</span></span><br><span class="line"><span class="attr">flv_support</span> = <span class="string">true</span></span><br><span class="line"><span class="attr">flv_extension</span> = <span class="string">flv</span></span><br><span class="line"><span class="attr">group_count</span> = <span class="string">0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># vim /etc/fdfs/http.conf</span></span><br><span class="line"><span class="meta">http.default_content_type</span> = <span class="string">application/octet-stream</span></span><br><span class="line"><span class="meta">http.mime_types_filename</span>=<span class="string">mime.types</span></span><br><span class="line"><span class="meta">http.anti_steal.check_token</span>=<span class="string">false</span></span><br><span class="line"><span class="meta">http.anti_steal.token_ttl</span>=<span class="string">900</span></span><br><span class="line"><span class="meta">http.anti_steal.secret_key</span>=<span class="string">FastDFS1234567890</span></span><br><span class="line"><span class="meta">http.anti_steal.token_check_fail</span>=<span class="string">/path/to/check_failed.jpg</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置mime.types</span></span><br><span class="line"><span class="attr">cp</span> <span class="string">/path/to/fastdfs/conf/mime.types /etc/fdfs/mime.types</span></span><br></pre></td></tr></table></figure>

 <figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 解压缩fastdfs-nginx-module_v1.16.tar.gz</span></span><br><span class="line">tar -zxf fastdfs-nginx-module_v1.16.tar.gz</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置fastdfs-nginx-module/src/config</span></span><br><span class="line"><span class="comment"># vim fastdfs-nginx-module/src/config</span></span><br><span class="line"><span class="comment"># CORE_INCS 和 CFLAGS</span></span><br><span class="line">ngx_addon_name=ngx_http_fastdfs_module</span><br><span class="line">HTTP_MODULES=<span class="string">"<span class="variable">$HTTP_MODULES</span> ngx_http_fastdfs_module"</span></span><br><span class="line">NGX_ADDON_SRCS=<span class="string">"<span class="variable">$NGX_ADDON_SRCS</span> <span class="variable">$ngx_addon_dir</span>/ngx_http_fastdfs_module.c"</span></span><br><span class="line">CORE_INCS=<span class="string">"<span class="variable">$CORE_INCS</span> /path/to/fastdfs /path/to/fastcommon/"</span></span><br><span class="line">CORE_LIBS=<span class="string">"<span class="variable">$CORE_LIBS</span> -L/usr/local/lib -lfastcommon -lfdfsclient"</span></span><br><span class="line">CFLAGS=<span class="string">"<span class="variable">$CFLAGS</span> -D_FILE_OFFSET_BITS=64 -DFDFS_OUTPUT_CHUNK_SIZE='256*1024' -DFDFS_MOD_CONF_FILENAME='\"/path/to/mod_fastdfs.conf\"'"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在Storage上安装nginx</p>
 <figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装nginx依赖包</span></span><br><span class="line">yum -y install gcc gcc-c++ make zlib-devel pcre-devel openssl-devel</span><br><span class="line"></span><br><span class="line"><span class="comment"># 建立nginx用户</span></span><br><span class="line">groupadd nginx</span><br><span class="line">useradd -g nginx nginx --shell=/sbin/nologin</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置，编译，安装nginx</span></span><br><span class="line">tar -zxf nginx-1.9.9.tar.gz</span><br><span class="line"><span class="built_in">cd</span> nginx-1.9.9</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>/nginx --add-module=/path/to/fastdfs-nginx-module/src --group=nginx --user=nginx</span><br><span class="line">make &amp;&amp; make install</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改nginx目录权限</span></span><br><span class="line">chown -R nginx:nginx /usr/<span class="built_in">local</span>/nginx</span><br></pre></td></tr></table></figure>

 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># 最简配置&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        # group1为该Storage所在的group</span><br><span class="line">        location &#x2F;group1&#x2F;M00 &#123;</span><br><span class="line">            # 该Storage的data目录</span><br><span class="line">            root &#x2F;mnt&#x2F;fastdfs&#x2F;data;</span><br><span class="line">            # 由于fastdfs保存的文件名已经编码，源文件名将丢失，应用可通过在请求url后加oname参数指定源文件名</span><br><span class="line">            if ($arg_oname !&#x3D; &#39;&#39;)&#123;</span><br><span class="line">                add_header Content-Disposition &quot;attachment;filename&#x3D;$arg_oname&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">            # 调用nginx-fastdfs-module模块</span><br><span class="line">            ngx_fastdfs_module;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

 <figure class="highlight zsh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动nginx，logs/error.log没有错误，即启动成功</span></span><br><span class="line">/usr/<span class="built_in">local</span>/nginx/sbin/nginx</span><br></pre></td></tr></table></figure>
</li>
<li><p>在其他服务器上安装用于图片文件负载的nginx</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"># 安装过程同上，只是不需要配置和安装fastdfs-nginx-module模块</span><br><span class="line"></span><br><span class="line"># 最简配置&#x2F;usr&#x2F;local&#x2F;nginx&#x2F;conf&#x2F;nginx.conf</span><br><span class="line">user  nginx;</span><br><span class="line">worker_processes  1;</span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line"></span><br><span class="line">    # group1的Storage集群</span><br><span class="line">    upstream group1_cluster &#123;</span><br><span class="line">        server 10.112.88.106;</span><br><span class="line">        server 10.112.88.109;</span><br><span class="line">        server 10.112.88.151;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    # group2的Storage集群</span><br><span class="line">    upstream group2_cluster &#123;</span><br><span class="line">        server 10.112.88.153;</span><br><span class="line">        server 10.112.88.158;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  10.112.88.105;</span><br><span class="line"></span><br><span class="line">        location &#x2F;group1 &#123;</span><br><span class="line">            proxy_pass              http:&#x2F;&#x2F;group1_cluster;</span><br><span class="line">            proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header        Host $http_host;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    location &#x2F;group2 &#123;</span><br><span class="line">            proxy_pass              http:&#x2F;&#x2F;group2_cluster;</span><br><span class="line">            proxy_set_header        X-Real-IP $remote_addr;</span><br><span class="line">            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">            proxy_set_header        Host $http_host;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
</li>
</ul>
<h2 id="4-使用介绍"><a href="#4-使用介绍" class="headerlink" title="4. 使用介绍"></a>4. 使用介绍</h2><p>通常使用时，会结合 <em>nginx</em> 来使用</p>
<p><img src="./images/fastdfs-nginx.jpg" alt="fastdfs"></p>
</p></div><div class="share"><span>分享到</span>&nbsp;<span class="soc"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></span><span class="soc"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></span><span class="soc"><a href="http://twitter.com/home?status=https://ilisten.github.io/2020/06/04/从零认识-fastDFS/%20Someone' target="_blank" rel="noopener"s blog%20从零认识 fastDFS" class="fa fa-twitter"></a></span></div><div class="pagination"><p class="clearfix"><span>&nbsp;</span><span class="next pagbuttons"><a role="navigation" href="/2020/06/03/hello-world/" title="Hello World">下一篇: Hello World&nbsp;<i class="fa fa-angle-double-right"></i></a></span></p></div></div></div></div><div class="visible-xs site-bottom-footer"><footer><p>&copy;&nbsp;2020&nbsp;<a target="_blank" href="https://ilisten.github.io" rel="noopener noreferrer">ilisten</a></p><p>Theme&nbsp;<a target="_blank" href="https://github.com/SumiMakito/hexo-theme-typography" rel="noopener noreferrer">Typography</a>&nbsp;by&nbsp;<a target="_blank" href="https://www.keep.moe" rel="noopener noreferrer">Makito</a></p><p>Proudly published with&nbsp;<a target="_blank" href="https://hexo.io" rel="noopener noreferrer">Hexo</a></p></footer></div></div></div></div><script src="/js/jquery-3.1.0.min.js"></script><script src="/js/bootstrap.min.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script><script src="/js/google-analytics.js"></script><script src="/js/typography.js"></script></body></html>